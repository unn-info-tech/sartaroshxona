{% extends 'sartaroshxona/base.html' %}
{% load static %}

{% block content %}
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Appointment page</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="{% static '/css/appointment.css' %}">

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'js/appointment_services.js' %}"></script>



{% include 'main/messages.html' %}



<div class="container">
  <div class="card p-4">
    <!-- <h1 class="text-center mb-4">Make an appointment</h1> -->
    <img src="{{ barber.profile_image.url }}" class="mx-auto d-block rounded-circle mb-3" alt="Profile Image" id="barber-image">
    <div class="text-center">
        <h5>{{ barber.user.username }}</h5>
    </div>
    <div class="row justify-content-center mb-3">
        <div class="col text-center">
            <p><strong>Location:</strong></p>
            <p>{{ barber.location }}</p>
        </div>
        <div class="col text-center">
            <p><strong>Store Name:</strong></p>
            <p>{{ barber.magazin }}</p>
        </div>
    </div>
    <div class="row justify-content-center">
        <div class="col text-center">
            <p><strong>Working Time:</strong></p>
            <p>{{ barber.start_work }} - {{ barber.end_work }}</p>
        </div>
        <div class="col text-center">
            <p><strong>Launch Time:</strong></p>
            <p>{{ barber.launch_start_time }} - {{ barber.launch_end_time }}</p>
        </div>
    </div>
  </div>

    

    

    <!-- Already appointed  -->
    <div class="card p-4">
      <h4>Already appointed</h4>
      <table>
          <thead>
              <tr>
                  <th>Customer Name</th>
                  <th>Appointment Date and Time</th>
              </tr>
          </thead>
          <tbody>
              <tr>
                <td>Username{{ username }}</td>
                <td>time{{ appointment.time }}</td>
              </tr>
              <tr>
                <td>Username{{ username }}</td>
                <td>time{{ appointment.time }}</td>
              </tr>
              
          </tbody>
      </table>
    </div>



    <!-- Services  -->
    <div class="card p-4">
      <h1>Book an Appointment with {{ barber.user }}</h1>
      
      <form method="post" onsubmit="prepareSelectedServices()">
        {% csrf_token %}
        <input type="datetime-local" name="appointment_time" class="form-control mb-4 black-input" value="{{ appointment_form.appointment_time.value }}" id="appointmentDatetime">
      
        <h2>Select Services</h2>
        <div class="services-list" id="services-container">
          {% for service in services %}
          <div class="service-item" data-service-id="{{ service.id }}" onclick="toggleService(this)">
            {{ service.title }} - Duration: {{ service.duration_minutes }} minutes - Price: {{ service.price }}
          </div>
          {% endfor %}
        </div>
      
        <div class="selected-services">
          <ul class="selected-list" id="selected-list"></ul>
          <p>Total Duration: <span id="total-duration"></span></p>
          <p>Total Price: <span id="total-price"></span></p>
        </div>
      
        <input type="hidden" name="selected_services" id="selected-services-input">
        <input type="submit" value="Book Appointment">
      </form>
      
      <script>
        function toggleService(service) {
          const isSelected = service.classList.toggle('selected');

          if (isSelected) {
            prepareSelectedServices(); // Update selected services and calculate total duration and price
          } else {
            service.style.pointerEvents = 'auto'; // Enable click for unselected service
          }

          updateSelectedServices(); // Update selected services list
        }
        
      
        function updateSelectedServices() {
          const selectedServices = document.querySelectorAll('.service-item.selected');
          const selectedServiceIds = Array.from(selectedServices).map(service => service.getAttribute('data-service-id'));
          document.getElementById('selected-services-input').value = JSON.stringify(selectedServiceIds);
      
          let totalDuration = 0;
          let totalPrice = 0;
      
          selectedServices.forEach(service => {
            const duration = parseInt(service.textContent.match(/Duration: (\d+) minutes/)[1]);
            const price = parseFloat(service.textContent.match(/Price: (\d+(\.\d+)?)/)[1]);
      
            totalDuration += duration;
            totalPrice += price;
          });
      
          document.getElementById('total-duration').textContent = `${totalDuration} minutes`;
          document.getElementById('total-price').textContent = `$${totalPrice.toFixed(2)}`;
        }
        
        function prepareSelectedServices() {
          updateSelectedServices();
        }
      </script>
    </div>
    
    

{% endblock %}